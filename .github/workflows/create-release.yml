name: "Create Release"

on:
  push:
    tags:
      - "v[0-9]*.[0-9]*.[0-9]*"

env:
  CHANGELOG_PRESET: conventionalcommits
  CHANGELOG_CONFIG_PATH: changelog.config.mjs
  CHANGELOG_FALLBACK_CONFIG: |
    // Changelog section mapping by Conventional Commit type.
    // - Rename a heading: change `section`.
    // - Hide a heading: set `hidden: true` for that type.
    // - Show a heading: set `hidden: false` (or remove `hidden`).
    // - Add support for a new type: add a new object to this array.

    const types = [
      { type: 'feat', section: 'âœ¨ Features', hidden: false },
      { type: 'fix', section: 'ðŸ› Fixes', hidden: false },
      { type: 'perf', section: 'âš¡ Performance Improvements', hidden: false },
      { type: 'revert', section: 'âª Reverts', hidden: false },
      { type: 'docs', section: 'ðŸ“š Documentation', hidden: false },
      { type: 'chore', section: 'ðŸ”§ Miscellaneous Chores', hidden: false },
      { type: 'refactor', section: 'ðŸ› ï¸ Code Refactoring', hidden: false },
      { type: 'build', section: 'ðŸ—ï¸ Build System', hidden: false },
      { type: 'ci', section: 'ðŸ”„ Continuous Integration', hidden: false },
      { type: 'test', section: 'ðŸ§ª Tests', hidden: false },
    ];

    const typeMap = new Map(types.map((entry) => [entry.type, entry]));

    export default {
      writer: {
        transform(commit) {
          const commitType = (
            commit.revert ? 'revert' : commit.type || ''
          ).toLowerCase();
          const entry = typeMap.get(commitType);

          if (entry?.hidden) {
            return undefined;
          }

          const sectionTitle = entry?.section || commit.type;

          if (!sectionTitle) {
            return undefined;
          }

          return {
            type: sectionTitle,
            scope: commit.scope === '*' ? '' : commit.scope,
            subject: commit.subject,
            shortHash:
              typeof commit.hash === 'string'
                ? commit.hash.substring(0, 7)
                : commit.shortHash,
            references: commit.references || [],
            notes: (commit.notes || []).map((note) => ({
              ...note,
              title: 'BREAKING CHANGES',
            })),
          };
        },
        groupBy: 'type',
        commitsSort: ['scope', 'subject'],
        noteGroupsSort: 'title',
      },
    };

jobs:
  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js ${{ vars.NODE_VERSION }} environment
        uses: actions/setup-node@v6
        with:
          cache: "npm"
          check-latest: true
          node-version: ${{ vars.NODE_VERSION }}

      - name: Install dependencies
        run: npm install

      - name: Prepare release data
        id: prep_release
        shell: bash
        run: |
          set -euo pipefail

          new_tag="${GITHUB_REF_NAME}"

          if ! [[ "$new_tag" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Tag '$new_tag' is not strict semver (vX.Y.Z)."
            exit 1
          fi

          last_tag="$(
            git tag --sort=-version:refname \
            | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' \
            | awk -v new="$new_tag" '$0 != new { print; exit }'
          )"

          if [[ -n "$last_tag" ]]; then
            full_changelog_url="https://github.com/${{ github.repository }}/compare/${last_tag}...${new_tag}"
          else
            full_changelog_url="https://github.com/${{ github.repository }}/releases/tag/${new_tag}"
          fi

          echo "new_tag=$new_tag" >> "$GITHUB_OUTPUT"
          echo "last_tag=$last_tag" >> "$GITHUB_OUTPUT"
          echo "full_changelog_url=$full_changelog_url" >> "$GITHUB_OUTPUT"

      - name: Generate Release via CLI
        shell: bash
        run: |
          set -euo pipefail

          changelog_config_path="$CHANGELOG_CONFIG_PATH"

          if [[ ! -f "$changelog_config_path" ]]; then
            changelog_config_path="$RUNNER_TEMP/changelog.config.mjs"
            printf '%s\n' "$CHANGELOG_FALLBACK_CONFIG" > "$changelog_config_path"
          fi

          {
            echo "## What's Changed"
            echo
            npx -y --silent conventional-changelog \
              -p "$CHANGELOG_PRESET" \
              -n "$changelog_config_path" \
              -u --stdout -r 1 -i /dev/null \
              | awk 'BEGIN { p = 0 } /^### / { p = 1 } p'
            echo
            echo "**Full Changelog:** ${{ steps.prep_release.outputs.full_changelog_url }}"
          } | gh release create "${{ steps.prep_release.outputs.new_tag }}" -t "${{ steps.prep_release.outputs.new_tag }}" -F -
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
