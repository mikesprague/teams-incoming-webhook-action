# GitHub Copilot Instructions for teams-incoming-webhook-action

This document provides context and guidelines for AI-assisted development on this project.

## Project Overview

**teams-incoming-webhook-action** is a GitHub Action that sends AdaptiveCard notifications to Microsoft Teams via Incoming Webhooks. It supports both simple text notifications and rich deployment status cards with commit information.

### Key Technologies

- **TypeScript 5.9+**: ES2023 target with strict type checking
- **Node.js**: 24.x minimum (Action runs on Node 20)
- **Vitest 4.x**: Modern test framework with 98%+ coverage
- **Biome 2.x**: Fast linting and formatting
- **GitHub Actions**: Custom action using @actions/core
- **@vercel/ncc**: Bundler for creating single-file distribution

## Project Structure

```
src/
  index.ts                    # Main entry point (top-level await)
  index.test.ts              # Main entry point tests
  lib/
    helpers.ts                # Color validation and emoji utilities
    helpers.test.ts          # Helper function tests
    cards/
      simple.ts              # Simple notification card generator
      simple.test.ts         # Simple card tests
      deploy.ts              # Deployment notification card generator
      deploy.test.ts         # Deploy card tests
dist/                        # Built action (generated by ncc)
types/                       # TypeScript declarations (generated)
```

## TypeScript Configuration

### Strict Mode Settings

The project uses TypeScript with balanced strict mode flags:

- **Enabled**: `strict`, `noUnusedLocals`, `noUnusedParameters`, `noImplicitReturns`, `noFallthroughCasesInSwitch`, `noImplicitOverride`, `exactOptionalPropertyTypes`, `verbatimModuleSyntax`
- **Not Enabled**: `noUncheckedIndexedAccess` (avoided to reduce verbosity)
- **Target**: ES2023 (modern JavaScript features)
- **Module System**: ESM with bundler resolution

### ESM Import Conventions

- Always use `.js` extension in import paths (even for `.ts` files)
- Use `import type` for type-only imports (enforced by `verbatimModuleSyntax`)
- Example:
  ```typescript
  import type { Endpoints } from '@octokit/types';
  import { getEmoji } from '../helpers.js';
  ```

### Top-Level Await

The main entry point ([src/index.ts](../src/index.ts)) uses top-level await instead of IIFE patterns:

```typescript
// ✅ Correct (modern)
try {
  const data = await fetchData();
  process(data);
} catch (error) {
  handleError(error);
}

// ❌ Avoid (legacy pattern)
void (async () => {
  // ...
})();
```

### Type Safety Patterns

1. **Properly type variables**: Don't use `any` or ignore type errors
   ```typescript
   // ✅ Correct
   let messageToPost: TeamsMessage;

   // ❌ Wrong
   // biome-ignore lint/suspicious/noImplicitAnyLet: TODO: add type(s)
   let messageToPost;
   ```

2. **Use nullish coalescing with fallbacks**: Provide defaults for optional environment variables
   ```typescript
   baseUrl: GITHUB_API_URL || 'https://api.github.com'
   ```

3. **Handle optional properties explicitly**:
   ```typescript
   const branch = GITHUB_REF?.split('/')[GITHUB_REF.split('/').length - 1];
   ```

## Testing Standards

### Test Framework: Vitest

- **Location**: Tests in `__tests__` directories adjacent to source files
- **Naming**: `*.test.ts` files
- **Coverage Thresholds**:
  - Lines: 98%
  - Functions: 100%
  - Branches: 92%
  - Statements: 98%
- **Current Coverage**: 100% lines, 100% functions, 100% statements, 100% branches (as of v1.16.1)
  - always shoot for 100% coverage and fall back on the thresholds if necessary, but never let coverage decrease
  - always maintain quality of tests and avoid writing superficial tests just to increase coverage numbers
  - attempt to follow existing test patterns and best practices for consistency unless you spot a clear improvement

### Testing Patterns

1. **Mock External Dependencies**:
   ```typescript
   vi.mock('@actions/core');
  vi.mock('node-fetch');
   ```

2. **Setup/Teardown with Environment**:
   ```typescript
   beforeEach(() => {
     process.env.GITHUB_SHA = 'test-sha';
     vi.mocked(mockCore.getInput).mockImplementation(...);
   });

   afterEach(() => {
     process.env = originalEnv;
     vi.clearAllMocks();
   });
   ```

3. **Test All Branches**: Cover success paths, error paths, edge cases, and optional parameters

4. **Use Descriptive Test Names**:
   ```typescript
   it('should handle undefined GITHUB_REF', async () => { ... });
   ```

### Running Tests

```bash
npm test                # Run all tests with coverage + lint + type check
npm run test:watch      # Watch mode for development
npm run test:coverage   # Coverage report only
npm run test:ui         # Interactive UI
```

## Code Quality

### Biome Configuration

- **Line Width**: 80 characters
- **Import Organization**: Automatic alphabetical sorting
- **Style**: Strict rules (240+ enabled)

### Before Committing

```bash
npm run lint            # Check code quality
npm run check           # TypeScript type checking
npm test                # Full test suite
npm run build           # Verify build works
```

### Auto-Fixing Issues

```bash
npx biome check --write ./src
```

## GitHub Action Specifics

### Action Metadata ([action.yml](../action.yml))

- **Runtime**: Node 20 (use compatible features)
- **Main**: `dist/index.js` (bundled by ncc)
- **Inputs**: All defined in action.yml with types and requirements

### Environment Variables

The action relies on GitHub-provided environment variables:
- `GITHUB_API_URL`
- `GITHUB_REF`
- `GITHUB_REPOSITORY`
- `GITHUB_RUN_ID`
- `GITHUB_RUN_NUMBER`
- `GITHUB_SERVER_URL`
- `GITHUB_SHA`

Always handle these as potentially undefined:
```typescript
const sha = GITHUB_SHA ?? '';
```

### Action Inputs

Accessed via `@actions/core`:
```typescript
const title = core.getInput('title', { required: true, trimWhitespace: true });
const isDeployCard = core.getBooleanInput('deploy-card', { required: false });
```

## Build and Distribution

### Building

```bash
npm run build           # Runs test + declarations + typedoc + ncc bundle
```

This creates:
- `dist/index.js`: Bundled action code (committed)
- `dist/licenses.txt`: License aggregation
- `types/`: TypeScript declarations
- `docs/`: TypeDoc HTML documentation

### Dependencies

- **Runtime Deps**: Kept minimal, included in bundle
  - `@actions/core`: GitHub Actions API
  - `@octokit/rest`: GitHub API client
  - `dayjs`: Timezone handling
  - `node-fetch`: Fetch polyfill for Octokit and webhook posting

- **Dev Deps**: Not bundled
  - Build tools, testing, documentation

### Versioning

- Uses [Conventional Commits](https://www.conventionalcommits.org/)
- Changelog auto-generated via `npm run changelog`
- Follows semantic versioning

## Common Tasks

### Adding a New Feature

1. Write failing tests in appropriate `__tests__/` directory
2. Implement feature in source file
3. Run `npm test` to verify tests pass and coverage maintained
4. Run `npm run lint` and fix any issues
5. Run `npm run build` to verify distribution builds
6. Update documentation if needed

### Adding a New Card Type

1. Create new file in `src/lib/cards/`
2. Export `populateCard` function returning Teams message structure
3. Create test file in `src/lib/cards/__tests__/`
4. Add dynamic import in `src/index.ts`
5. Update action.yml if new inputs needed
6. Document in README.md

### Fixing a Bug

1. Write a failing test that reproduces the bug
2. Fix the bug
3. Verify test passes
4. Check that coverage hasn't decreased
5. Verify no existing tests broke

## AdaptiveCard Structure

Microsoft Teams messages use the [AdaptiveCard](https://adaptivecards.microsoft.com/) format:

```typescript
{
  type: 'message',
  attachments: [{
    contentType: 'application/vnd.microsoft.card.adaptive',
    content: {
      type: 'AdaptiveCard',
      $schema: 'http://adaptivecards.io/schemas/adaptive-card.json',
      version: '1.3',
      body: [ /* card elements */ ]
    }
  }]
}
```

### Card Elements

- **Containers**: Group elements with styling
- **TextBlocks**: Display text with formatting
- **FactSets**: Key-value pairs
- **ActionSets**: Buttons and links

### Color Schemes

- `emphasis` (gray) - default
- `good` (green) - success
- `accent` (blue) - info
- `warning` (yellow) - warning
- `attention` (red) - failure

## Debugging

### Local Testing

Tests run with mocked GitHub Actions context. To test locally:

1. Set environment variables in test setup
2. Mock @actions/core functions
3. Mock external API calls (Octokit, fetch)
4. Use Vitest's `vi.waitFor()` for async operations

### Integration Testing

The `.github/workflows/build-and-test.yml` workflow runs actual end-to-end tests by executing the action with real Teams webhooks.

## Best Practices

### Do's ✅

- Use top-level await for async operations
- Type all variables explicitly
- Test all code paths including errors
- Handle undefined environment variables
- Use nullish coalescing (`??`) for defaults
- Keep line length under 80 characters
- Organize imports alphabetically (Biome handles this)
- Write descriptive commit messages

### Don'ts ❌

- Don't use IIFE patterns (use top-level await)
- Don't ignore TypeScript errors
- Don't use `any` type
- Don't use deprecated string methods (`.substr()` → `.slice()`)
- Don't commit without running tests
- Don't decrease test coverage
- Don't bundle unnecessary dependencies

## Questions or Issues?

- Check existing tests for patterns
- Review TypeScript docs for strict mode features
- Consult [Vitest documentation](https://vitest.dev/)
- See [AdaptiveCards documentation](https://adaptivecards.microsoft.com/)
- Reference [GitHub Actions toolkit](https://github.com/actions/toolkit)

## Context7 Documentation Access

Context7 tools are available via the local MCP server and can be used to
resolve and search documentation for many libraries, frameworks, and
platforms. Always look up and verify the latest documentation for any library
or framework in use. Never assume model knowledge is current; check docs every
time.

## Versioning Policy

Always use the latest versions of any current or newly added
libraries/frameworks unless the user explicitly specifies otherwise. Never use
outdated technologies.

## Testing New Features

All new features must include corresponding tests with full coverage.

---

*Last Updated: February 10, 2026*
*TypeScript Version: 5.9.3*
*Node Version: 24.x*
*Vitest Version: 4.0.18*
